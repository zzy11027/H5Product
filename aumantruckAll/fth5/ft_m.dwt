<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
    <title>欧曼2019款国六法规渣土车优惠活动</title>
    <link rel="stylesheet" href="templates/fth5/css/ft_m.css">

     <script src="js/region2.js" type="text/javascript"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>

        wx.config({
            debug: false, // 开启调试模式调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印�?
            appId: 'wxa1ef57725e6a43a9', // 必填，公众号的唯一标识
            timestamp: '{$arr.timestamp}', // 必填，生成签名的时间
            nonceStr: '{$arr.noncestr}', // 必填，生成签名的随机
            signature: '{$arr.sha1}',// 必填，签名，见附
            jsApiList: [
                "onMenuShareTimeline",
                "onMenuShareAppMessage"
            ] // 必填，需要使用的JS接口列表，所有JS接口列表见附
        });
        wx.ready(function () {
            wx.onMenuShareAppMessage({
                title: '欧曼2019款国六法规渣土车北京区域上市', // 分享标题
                desc: '看上市直播，1元定金抢666元抵5666元购车优惠！', // 分享描述
                link: 'http://www.aumantruck.com/mobile/defend51.php', // 分享链接
                imgUrl: 'http://www.aumantruck.com/mobile/templates/fth5/img/fxfx.png', // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function () {

                },
                cancel: function () {
                    //alert("取消成功");
                    // 用户取消分享后执行的回调函数
                }

            });
            wx.onMenuShareTimeline({
                title: '欧曼2019款国六法规渣土车北京区域上市', // 分享标题
                link: 'http://www.aumantruck.com/mobile/defend51.php', // 分享链接
                imgUrl: 'http://www.aumantruck.com/mobile/templates/fth5/img/fxfx.png', // 分享图标
                success: function () {

                },
                cancel: function () {
                  //  alert("取消成功");
                    // 用户取消分享后执行的回调函数
                }
            });
        })

    </script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?12ebce5ddde1b698958bacdd8cce7342";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<body>
          

    <div class="warp">
      
        <div class="in">
            <input type="hidden" name='openid' value='{$openid}' id='openid'>
            <input type="hidden" name='token' value='{$token}' id='token'>
            <input type="text" class="in1">
            <input type="text" class="in2">
            <select name="select_1" class="inp3" id="input-1"
                style="appearance:none;-moz-appearance:none;-webkit-appearance:none;" value="欧曼GTL渣土车">
                <option>欧曼GTL渣土车</option>
            </select>
            <select id="selProvinces_1" onchange="region.changed(this, 2, 'selCities_1')" name='apply_field3_1'
                class="inp4 sheng">
                <option value="">请选择省份</option>
                <!-- {foreach from=$city_list item=country} -->
                <option value="{$country.region_id}" <!-- {if $country.region_id eq $fieldData.agency_province}selected{/if}-->{$country.region_name}</option>
                 <!-- {/foreach} -->
            </select>

            <select id="selCities_1" onchange="getDistributors(1);" name="apply_field4_1" class="inp5 shi">
                <option value="">请选择城市</option>
                  <!-- {foreach from=$fieldData.citys item=city} -->
                    <option value="{$city.region_id}" <!-- {if $city.region_id eq $fieldData.agency_city}selected{/if}-->>{$city.region_name}</option>
                    <!-- {/foreach} -->
           
            </select>

            <select id="apply_field6_1" name="apply_field5_1" class="inp6 jingxs">
                <option value="">请选择经销商</option>
               <!-- {foreach from=$distributors item=distributor} -->
            <option value="{$distributor.distributors_id}" <!--{if $fieldData[6] eq $distributor.distributors_id}selected{/if}-->>{$distributor.distributors_name}</option>
            <!-- {/foreach} -->
            </select>
            <input type="text" class="in3" id='yzm'>
            <span class="yz" onclick="yz()"></span>
            <div class="btn" onclick="tj()"></div>
        </div>
    </div>
    <script src="templates/fth5/js/jquery.min.js"></script>
    <script>
        var arr
        (function(){
          $.ajax({
            type: 'POST',
                dataType: 'json',
                url: 'http://www.aumantruck.com/mobile/defend51.php?step=yzm',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", token);
                },
                success:function(data){
                    $('.yz').append(data);
                    console.log(data)
                }
          })
        })()
        function yz(){
            $.ajax({
            type: 'POST',
                dataType: 'json',
                url: 'http://www.aumantruck.com/mobile/defend51.php?step=yzm',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", token);
                },
                success:function(data){
                    $('.yz').html(data);
                    console.log(data)
                }
          })
        }
        function tj() {

            var inp2 = $("#selProvinces_1").find("option:selected").text(); //获取   select下拉被选中的文本直
            var inp3 = $("#selCities_1").find("option:selected").text();
            var inp4 = $("#apply_field6_1").find("option:selected").text();
            var sheng = $(".sheng").find("option:selected").text();
            var shi = $(".shi").find("option:selected").text();
            var jingxs = $(".jingxs").find("option:selected").text();
            var inp5 = $(".in1").val()
            var inp6 = $(".in2").val();
            var token = $("#token").val();
            var openid = $("#openid").val();
            var yzm = $("#yzm").val();
            // console.log(inp1, inp2, inp3, inp4, inp5, inp6)
            if (inp5 == "") {
                alert("请输入您的姓名");
                return false;
            }
            if (inp6 == "") {
                alert("请输入您的电话");
                return false;
            }
            var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;

            if (!reg.test(inp6)) {
                alert("请输入正确的手机号");
                return false;
            }

           
            if (sheng == "" || sheng == '请选择省份') {
                alert("请选择省份");
                return false;
            }
            if (shi == "" || shi == '请选择城市') {
                alert("请选择城市");
                return false;
            }
            if (jingxs == "" || jingxs == '请选择经销商') {
                alert("请选择经销商");
                return false;
            }
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: 'http://www.aumantruck.com/mobile/defend51.php?step=book',
                data: {
                    openid: openid,
                    yzm : yzm
                },
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", token);
                },
                success: function (data) {
                    if(data.res==8){
                        alert('非法请求!');
                        return false;
                    }
                    if(data.res==9){
                        alert('非法请求!');
                        return false;
                    }
                    if(data.res==10){
                        alert('已抢空!');
                        return false;
                    }
                    if (typeof WeixinJSBridge == "undefined"){
                        if( document.addEventListener ){
                            document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
                        }else if (document.attachEvent){
                            document.attachEvent('WeixinJSBridgeReady', jsApiCall); 
                            document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
                        }
                    }else{
                        WeixinJSBridge.invoke(
                            'getBrandWCPayRequest', {
                                "appId":data.appId[0],     //公众号名称，由商户传入     
                                "timeStamp":data.timeStamp,         //时间戳，自1970年以来的秒数     
                                "nonceStr":data.nonceStr, //随机串     
                                "package":data.package,     
                                "signType":data.signType,         //微信签名方式：     
                                "paySign":data.paySign //微信签名 
                            },
                            function(res){
                                if(res.err_msg == "get_brand_wcpay_request:ok" ){
                                    $.ajax({
                                        type: 'POST',
                                        dataType: 'json',
                                        url: 'http://www.aumantruck.com/mobile/defend51.php?step=insert_info',
                                        data: {
                                            prov_id: inp2,//省
                                            city_id: inp3,//市
                                            agency_id: inp4,//经销商
                                            name: inp5,//姓名
                                            phone: inp6,//手机号
                                            openid: openid,
                                        },
                                        success: function (data) {
                                            alert('抢购成功，请等待经销商与您联系！');
                                        }
                                    });
                                } 
                            }
                        );
                    }
                }
            });
        }


function getDistributors(goods_id){
    if(goods_id == 1){
        var prov_obj = document.getElementById("selProvinces_1");
        var prov = prov_obj.options[prov_obj.options.selectedIndex].value;
        var city_obj = document.getElementById("selCities_1");
        var city = city_obj.options[city_obj.options.selectedIndex].value;
    }
    if(city){
        $.ajax({
            type: "GET",
            url: "http://www.aumantruck.com/mobile/defend51.php?step=check_by_region&prov="+prov+"&city="+city+"&is_activity=1&goods_id="+goods_id,
            dataType: 'json',
            success: function (result) {
                if(result.error == 1){
                    return false;
                }
                var content = result.content;
                var option_html = "";
                if(content.length>0){
                    for(var i = 0; i < content.length; i++){
                        option_html += "<option value='"+ content[i]['agency_id'] +"'>"+ content[i]['agency_name'] +"</option>";
                    }
                }else{
                    option_html += "<option value=''>这里提不到车，去隔壁市看看吧</option>";
                }
                if(goods_id == 1){
                    $("#apply_field6_1").html(option_html);
                }
                if(goods_id == 2){
                    $("#apply_field6_2").html(option_html);
                }
                if(goods_id == 3){
                    $("#apply_field6_3").html(option_html);
                }
                if(goods_id == 4){
                    $("#apply_field6_4").html(option_html);
                }
                if(goods_id == 5){
                    $("#apply_field6_5").html(option_html);
                }

            }
        });
    }
    }
    
    </script>

</body>

</html>